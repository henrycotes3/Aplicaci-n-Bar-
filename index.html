<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar√°: Tu Gu√≠a para Predicar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #311B92; /* Un p√∫rpura oscuro que evoca un sentido de solemnidad */
        }
    </style>
</head>
<body class="text-gray-100 flex flex-col items-center justify-h-screen p-4">

    <div class="flex items-center justify-center gap-4 mb-4">
        <img src="https://i.imgur.com/8Q90GE4.png" alt="Logotipo de Bar√°" class="h-32 w-auto"> <!-- Reemplaza esta URL con el enlace directo de tu logotipo. -->
        <h1 class="text-4xl font-bold text-white">
            Bar√°: Tu Gu√≠a para Predicar
        </h1>
    </div>

    <div class="bg-gray-800 p-8 rounded-2xl shadow-xl max-w-4xl w-full bg-opacity-90">
        <div class="space-y-6">
            <h2 class="text-xl font-semibold text-white">Generar Reflexi√≥n ‚ú®</h2>
            <p class="text-gray-300">
                Introduce un pasaje de la Biblia (por ejemplo, "Juan 3:16") o un tema de reflexi√≥n para recibir una idea instant√°nea.
            </p>

            <textarea id="reflection-input" rows="4" class="w-full p-4 text-gray-800 bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="Escribe un pasaje o tema aqu√≠..."></textarea>
            
            <div id="enfoque-container" class="flex flex-wrap justify-center sm:justify-start gap-2 mb-4">
                <button data-enfoque="general" class="enfoque-btn px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95 text-sm">General</button>
                <button data-enfoque="pastoral" class="enfoque-btn px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95 text-sm">Pastoral</button>
                <button data-enfoque="teol√≥gico" class="enfoque-btn px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95 text-sm">Teol√≥gico</button>
                <button data-enfoque="espiritual" class="enfoque-btn px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95 text-sm">Espiritual</button>
                <button data-enfoque="humano" class="enfoque-btn px-4 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95 text-sm">Humano</button>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button id="generate-btn" class="w-full sm:w-1/2 bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95">
                    Generar reflexi√≥n ‚ú®
                </button>
                <button id="tts-btn" class="w-full sm:w-1/2 bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95" disabled>
                    Escuchar reflexi√≥n üîä
                </button>
            </div>
            <button id="fathers-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95">
                Consultar a los Padres de la Iglesia üìú
            </button>
            <button id="church-docs-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95">
                Consultar Documentos de la Iglesia üìö
            </button>
            
            <div id="reflection-output" class="bg-gray-700 text-gray-200 p-4 rounded-lg min-h-[100px] flex items-center justify-center text-center italic">
                La reflexi√≥n aparecer√° aqu√≠...
            </div>
            <div id="fathers-output" class="bg-gray-700 text-gray-200 p-4 rounded-lg mt-4 hidden">
                <h3 class="font-bold text-white mb-2">Visi√≥n de los Padres de la Iglesia</h3>
                <div id="fathers-text" class="italic">El conocimiento de los Padres de la Iglesia aparecer√° aqu√≠...</div>
            </div>
            <div id="church-docs-output" class="bg-gray-700 text-gray-200 p-4 rounded-lg mt-4 hidden">
                <h3 class="font-bold text-white mb-2">Aporte del Magisterio de la Iglesia</h3>
                <div id="church-docs-text" class="italic">El aporte del Magisterio de la Iglesia aparecer√° aqu√≠...</div>
            </div>

            <audio id="audio-player" class="hidden"></audio>
        </div>
        
        <div id="download-buttons" class="flex flex-col sm:flex-row gap-4 mt-6 hidden">
            <button id="download-pdf-btn" class="w-full sm:w-1/2 bg-gray-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-gray-700 transition-all active:scale-95">
                Descargar PDF üìÑ
            </button>
            <button id="download-word-btn" class="w-full sm:w-1/2 bg-gray-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-gray-700 transition-all active:scale-95">
                Descargar Word üìÑ
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('reflection-input');
            const generateBtn = document.getElementById('generate-btn');
            const ttsBtn = document.getElementById('tts-btn');
            const fathersBtn = document.getElementById('fathers-btn');
            const churchDocsBtn = document.getElementById('church-docs-btn');
            const output = document.getElementById('reflection-output');
            const fathersOutput = document.getElementById('fathers-output');
            const fathersText = document.getElementById('fathers-text');
            const churchDocsOutput = document.getElementById('church-docs-output');
            const churchDocsText = document = document.getElementById('church-docs-text');
            const audioPlayer = document.getElementById('audio-player');
            const downloadButtons = document.getElementById('download-buttons');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadWordBtn = document.getElementById('download-word-btn');
            const enfoqueButtons = document.querySelectorAll('.enfoque-btn');

            const API_KEY = ""; 
            
            const GENERATE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

            let selectedEnfoque = 'general';

            // L√≥gica para cambiar el enfoque seleccionado
            enfoqueButtons.forEach(button => {
                button.addEventListener('click', () => {
                    enfoqueButtons.forEach(btn => {
                        btn.classList.remove('bg-indigo-600');
                        btn.classList.add('bg-gray-600');
                    });
                    button.classList.remove('bg-gray-600');
                    button.classList.add('bg-indigo-600');
                    selectedEnfoque = button.dataset.enfoque;
                });
            });

            // Funci√≥n para convertir base64 a ArrayBuffer
            const base64ToArrayBuffer = (base64) => {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            };

            // Funci√≥n para convertir PCM a WAV
            const pcmToWav = (pcmData, sampleRate) => {
                const wavData = new ArrayBuffer(44 + pcmData.byteLength);
                const view = new DataView(wavData);

                // RIFF identifier
                view.setUint32(0, 0x46464952, true);
                // file size
                view.setUint32(4, 36 + pcmData.byteLength, true);
                // RIFF type
                view.setUint32(8, 0x45564157, true);
                // format chunk identifier
                view.setUint32(12, 0x20746d66, true);
                // format chunk length
                view.setUint32(16, 16, true);
                // sample format (raw)
                view.setUint16(20, 1, true);
                // channel count
                view.setUint16(22, 1, true);
                // sample rate
                view.setUint32(24, sampleRate, true);
                // byte rate (sample rate * block align)
                view.setUint32(28, sampleRate * 2, true);
                // block align (channel count * bytes per sample)
                view.setUint16(32, 2, true);
                // bits per sample
                view.setUint16(34, 16, true);
                // data chunk identifier
                view.setUint32(36, 0x61746164, true);
                // data chunk length
                view.setUint32(40, pcmData.byteLength, true);

                const pcmView = new Int16Array(pcmData);
                for (let i = 0; i < pcmView.length; i++) {
                    view.setInt16(44 + i * 2, pcmView[i], true);
                }

                return new Blob([view], { type: 'audio/wav' });
            };

            const parseAndFormatOutput = (text, container) => {
                container.innerHTML = '';
                const lines = text.split('\n');
                let currentList = null;
            
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '') {
                        if (currentList) {
                            currentList = null;
                        }
                        return;
                    }
            
                    // Detectar t√≠tulos o subt√≠tulos
                    if (trimmedLine.startsWith('### ') || trimmedLine.startsWith('## ') || trimmedLine.startsWith('# ')) {
                        const h3 = document.createElement('h3');
                        h3.textContent = trimmedLine.replace(/^#+\s*/, '');
                        h3.className = 'text-xl font-bold mt-4 mb-2 text-white';
                        container.appendChild(h3);
                        currentList = null;
                        return;
                    }
            
                    // Detectar vi√±etas o listas numeradas
                    if (trimmedLine.startsWith('*') || trimmedLine.startsWith('-') || trimmedLine.match(/^\d+\./)) {
                        if (!currentList || (trimmedLine.match(/^\d+\./) && currentList.tagName !== 'OL') || ((trimmedLine.startsWith('*') || trimmedLine.startsWith('-')) && currentList.tagName !== 'UL')) {
                            const listType = trimmedLine.match(/^\d+\./) ? 'ol' : 'ul';
                            currentList = document.createElement(listType);
                            currentList.className = 'list-inside mb-4 ml-4';
                            container.appendChild(currentList);
                        }
                        const listItem = document.createElement('li');
                        listItem.textContent = trimmedLine.replace(/^[\*\-]\s*|^\d+\.\s*/, '');
                        listItem.className = 'text-justify';
                        currentList.appendChild(listItem);
                    } else {
                        currentList = null;
                        const p = document.createElement('p');
                        p.textContent = trimmedLine;
                        p.className = 'mb-4 text-justify first-line:indent-4';
                        container.appendChild(p);
                    }
                });
            };
            
            const handleApiRequest = async (prompt, systemInstruction, outputContainer) => {
                const retryOptions = {
                    retries: 3,
                    delay: 1000
                };
                
                let lastError = null;
                for (let i = 0; i < retryOptions.retries; i++) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: {
                                parts: [{ text: systemInstruction }]
                            },
                        };
                        
                        const response = await fetch(GENERATE_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`Error en la API: ${response.statusText}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const generatedText = candidate.content.parts[0].text;
                            
                            // L√≥gica para el recuadro de reflexi√≥n como un solo bloque
                            if (outputContainer === output) {
                                output.innerHTML = `<p class="text-justify">${generatedText}</p>`;
                            } else {
                                parseAndFormatOutput(generatedText, outputContainer);
                            }
                            
                            lastError = null;
                            break;
                        } else {
                            throw new Error("Respuesta de la API vac√≠a o inv√°lida.");
                        }

                    } catch (error) {
                        console.error(`Intento ${i + 1} fallido:`, error);
                        lastError = error;
                        await new Promise(res => setTimeout(res, retryOptions.delay * (i + 1)));
                    }
                }

                if (lastError) {
                    console.error("Error en la solicitud:", lastError);
                    outputContainer.innerHTML = "<p>Hubo un error al conectar con el servicio. Por favor, int√©ntalo de nuevo.</p>";
                }
            };

            generateBtn.addEventListener('click', async () => {
                const prompt = input.value.trim();
                if (!prompt) {
                    output.innerHTML = "<p>Por favor, escribe un pasaje de la Biblia o un tema.</p>";
                    return;
                }

                output.innerHTML = `<p class="italic text-center">
                    Esta herramienta es solo una gu√≠a inicial. La verdadera reflexi√≥n nace de la oraci√≥n y del di√°logo con el Esp√≠ritu Santo. Usa este contenido como un punto de partida para tu predicaci√≥n.
                    <br><br>
                    <button id="continue-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-indigo-700 transition-all active:scale-95 mt-2">Continuar</button>
                    <button id="cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:bg-gray-700 transition-all active:scale-95 mt-2">Cancelar</button>
                </p>`;
                
                generateBtn.disabled = true;
                ttsBtn.disabled = true;
                fathersBtn.disabled = true;
                churchDocsBtn.disabled = true;

                document.getElementById('continue-btn').addEventListener('click', async () => {
                    output.innerHTML = "<p class='italic'>Generando reflexi√≥n...</p>";
                    
                    downloadButtons.classList.add('hidden');
                    fathersOutput.classList.add('hidden');
                    churchDocsOutput.classList.add('hidden');

                    const reflectionPrompts = {
                        general: `Eres un experto en teolog√≠a y consejero espiritual cat√≥lico. Tu objetivo es generar una reflexi√≥n con una estructura impecable para facilitar su lectura y uso en una homil√≠a. Incluye al menos dos citas b√≠blicas que apoyen la reflexi√≥n. La respuesta debe ser f√°cil de leer y asimilar.`,
                        pastoral: `Eres un experto en teolog√≠a y consejero espiritual cat√≥lico con un enfoque pastoral. Genera una reflexi√≥n que se aplique directamente a la vida y los desaf√≠os cotidianos de los fieles. Incluye consejos pr√°cticos y al menos dos citas b√≠blicas.`,
                        teol√≥gico: `Eres un experto en teolog√≠a y un erudito b√≠blico cat√≥lico. Genera una reflexi√≥n que profundice en la doctrina y los conceptos teol√≥gicos del texto b√≠blico. Incluye al menos dos citas b√≠blicas y explica su significado en el contexto de la fe.`,
                        espiritual: `Eres un experto en teolog√≠a y un gu√≠a espiritual cat√≥lico. Genera una reflexi√≥n que invite a la oraci√≥n, la meditaci√≥n y el crecimiento personal en la fe. Enf√≥cate en la relaci√≥n del creyente con Dios. Incluye al menos dos citas b√≠blicas.`,
                        humano: `Eres un experto en teolog√≠a con un enfoque en la psicolog√≠a humana y las relaciones interpersonales. Genera una reflexi√≥n que explore los sentimientos, motivaciones y luchas humanas en el texto b√≠blico. Incluye al menos dos citas b√≠blicas que hablen al coraz√≥n humano.`
                    };
                    
                    const systemPrompt = reflectionPrompts[selectedEnfoque] || reflectionPrompts.general;
                    
                    await handleApiRequest(`Tema de la reflexi√≥n: ${prompt}`, systemPrompt, output);

                    generateBtn.disabled = false;
                    ttsBtn.disabled = false;
                    fathersBtn.disabled = false;
                    churchDocsBtn.disabled = false;
                    downloadButtons.classList.remove('hidden');
                });

                document.getElementById('cancel-btn').addEventListener('click', () => {
                    output.innerHTML = `<p class="italic text-center">La reflexi√≥n aparecer√° aqu√≠...</p>`;
                    generateBtn.disabled = false;
                    ttsBtn.disabled = true;
                    fathersBtn.disabled = false;
                    churchDocsBtn.disabled = false;
                });
            });

            ttsBtn.addEventListener('click', async () => {
                const textToSpeak = output.textContent;
                if (!textToSpeak || textToSpeak.includes("aparecer√° aqu√≠") || textToSpeak.includes("Generando reflexi√≥n")) {
                    return;
                }

                ttsBtn.textContent = "Cargando audio...";
                ttsBtn.disabled = true;
                fathersBtn.disabled = true;
                churchDocsBtn.disabled = true;

                try {
                    const payload = {
                        contents: [{ parts: [{ text: textToSpeak }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Kore" }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Error en la API TTS: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        
                        const audioUrl = URL.createObjectURL(wavBlob);
                        audioPlayer.src = audioUrl;
                        audioPlayer.play();
                    } else {
                        throw new Error("Datos de audio no v√°lidos en la respuesta.");
                    }

                } catch (error) {
                    console.error("Error al reproducir el audio:", error);
                    alert("No se pudo reproducir el audio. Por favor, int√©ntalo de nuevo.");
                } finally {
                    ttsBtn.textContent = "Escuchar reflexi√≥n üîä";
                    ttsBtn.disabled = false;
                    fathersBtn.disabled = false;
                    churchDocsBtn.disabled = false;
                }
            });

            fathersBtn.addEventListener('click', async () => {
                const prompt = input.value.trim();
                if (!prompt) {
                    fathersText.innerHTML = "<p>Por favor, escribe un pasaje o un tema en el cuadro de texto principal.</p>";
                    fathersOutput.classList.remove('hidden'); 
                    return;
                }
                
                fathersText.innerHTML = "<p class='italic'>Consultando a los Padres de la Iglesia...</p>";
                fathersOutput.classList.remove('hidden');
                fathersBtn.disabled = true;
                generateBtn.disabled = true;
                ttsBtn.disabled = true;
                churchDocsBtn.disabled = true;
                
                const systemInstruction = "Act√∫a como un erudito en patr√≠stica y teolog√≠a cat√≥lica. Encuentra y resume las interpretaciones de los Padres de la Iglesia (como San Agust√≠n, San Jer√≥nimo, San Gregorio Magno, etc.) o de otros te√≥logos cat√≥licos sobre el siguiente pasaje o tema. Cita a los autores de las interpretaciones y, si es posible, sus obras o ep√≠stolas, mostrando c√≥mo estas ideas se alinean o profundizan el mensaje. Organiza tu respuesta en p√°rrafos con sangr√≠a y, si aplica, con t√≠tulos, vi√±etas o listas numeradas para una lectura m√°s clara.";

                await handleApiRequest(`Interpretaci√≥n de los Padres de la Iglesia sobre: ${prompt}`, systemInstruction, fathersText);

                fathersBtn.disabled = false;
                generateBtn.disabled = false;
                ttsBtn.disabled = false;
                churchDocsBtn.disabled = false;
            });
            
            churchDocsBtn.addEventListener('click', async () => {
                const prompt = input.value.trim();
                if (!prompt) {
                    churchDocsText.innerHTML = "<p>Por favor, escribe un pasaje o un tema en el cuadro de texto principal.</p>";
                    churchDocsOutput.classList.remove('hidden'); 
                    return;
                }
                
                churchDocsText.innerHTML = "<p class='italic'>Consultando el Magisterio de la Iglesia...</p>";
                churchDocsOutput.classList.remove('hidden');
                fathersBtn.disabled = true;
                generateBtn.disabled = true;
                ttsBtn.disabled = true;
                churchDocsBtn.disabled = true;
                
                const systemInstruction = "Eres un experto en el magisterio de la Iglesia Cat√≥lica. Tu objetivo es encontrar y resumir las ense√±anzas de la Iglesia sobre el siguiente pasaje o tema, citando documentos oficiales como el Catecismo de la Iglesia Cat√≥lica, enc√≠clicas, constituciones conciliares o cartas apost√≥licas. Explica c√≥mo estos documentos profundizan o aclaran el mensaje. Organiza tu respuesta en p√°rrafos y, si es necesario, con vi√±etas o listas para una mejor lectura. La respuesta debe ser de una manera formal y teol√≥gica.";

                await handleApiRequest(`Aporte del Magisterio de la Iglesia sobre: ${prompt}`, systemInstruction, churchDocsText);

                fathersBtn.disabled = false;
                generateBtn.disabled = false;
                ttsBtn.disabled = false;
                churchDocsBtn.disabled = false;
            });

            // Funci√≥n para descargar texto como archivo .doc
            const downloadHtmlAsWord = (htmlContent, filename) => {
                const header = "<!DOCTYPE html><html><head><title>Document</title><meta charset='utf-8'></head><body>";
                const footer = "</body></html>";
                const content = header + htmlContent + footer;
                const blob = new Blob([content], { type: 'application/msword' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Funci√≥n para descargar texto como PDF
            const downloadTextAsPdf = (text, filename) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("Helvetica");
                doc.setFontSize(12);

                const margin = 15;
                const maxLineWidth = 180;
                const lineHeight = 7; 
                const pageHeight = doc.internal.pageSize.height;
                
                const lines = doc.splitTextToSize(text, maxLineWidth);
                
                let y = margin;
                lines.forEach(line => {
                    if (y + lineHeight > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, margin, y);
                    y += lineHeight;
                });
                
                doc.save(filename);
            };

            downloadPdfBtn.addEventListener('click', () => {
                let content = '';
                let filename = '';
                if (!fathersOutput.classList.contains('hidden')) {
                    content = fathersText.textContent;
                    filename = 'ConsultaPadresDeLaIglesia.pdf';
                } else if (!churchDocsOutput.classList.contains('hidden')) {
                    content = churchDocsText.textContent;
                    filename = 'AporteMagisterioDeLaIglesia.pdf';
                } else {
                    content = output.textContent;
                    filename = 'Reflexion.pdf';
                }
                if (content.length > 0) {
                    downloadTextAsPdf(content, filename);
                }
            });

            downloadWordBtn.addEventListener('click', () => {
                let content = '';
                let filename = '';
                if (!fathersOutput.classList.contains('hidden')) {
                    content = fathersText.innerHTML;
                    filename = 'ConsultaPadresDeLaIglesia.doc';
                } else if (!churchDocsOutput.classList.contains('hidden')) {
                    content = churchDocsText.innerHTML;
                    filename = 'AporteMagisterioDeLaIglesia.doc';
                } else {
                    content = output.innerHTML;
                    filename = 'Reflexion.doc';
                }
                if (content.length > 0) {
                    downloadHtmlAsWord(content, filename);
                }
            });
        });
    </script>
</body>
</html>
